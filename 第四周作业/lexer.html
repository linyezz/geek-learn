<pre>
<script>
  // let xregexp = {
  //   InputElements: /<Whitespace>|<LineTerminator>|<Comments>/,
  //   Whitespace: / /,
  //   LineTerminator: /\n/,
  //   Comments: / |\n|\/\*([^*]|\*[^\/])*\*\/|\/\/[^\n]*/
  // }
  
  class XRegExp {
    constructor(source,flag,root = "root"){
      this.table = new Map();
      this.regexp = new RegExp(this.compileRegExp(source,root,0).source,flag);
      console.log(this.regexp);
      console.log(this.table);
    }
    compileRegExp(source, name,start) {
    if(source[name] instanceof RegExp){
      return {
        source:source[name].source,
        length:0
      }
      // return source[name].source;
    }
    let length = 0;
    let regexp = source[name].replace(
      /\<([^>]+)\>/g,
       (str, $1)=> {
        this.table.set(start + length,$1);
        this.table.set($1,start + length);

        ++length;

        let r = this.compileRegExp(source, $1, start + length);
        length += r.length;
        return r.source;
      }
    );
    // return regexp;
    return {
      source:regexp,
      length:length
    }
  }
    exec(string){
      let r = this.regexp.exec(string);
                console.log(r.length);
                for (let i = 0; i < r.length; i++) {
                    const element = r[i];
                    if (element !== void 0) {
                        // console.log(this.table.get(i - 1));
                        r[this.table.get(i - 1)] = element;
                    }
                }
                return r;
    }
    get lastIndex(){
      return this.regexp.lastIndex;
    }
    set lastIndex(value){
      return this.regexp.lastIndex = value;
    }
  }
  
  // function compileRegExp(xregexp, name) {
  //   if(xregexp[name] instanceof RegExp){
  //     return xregexp[name].source;
  //   }
  //   let regexp = xregexp[name].replace(
  //     /\<([^>]+)\>/g,
  //     function (str, $1) {
  //       return compileRegExp(xregexp, $1);
  //     }
  //   );
  //   return regexp;
  // }

  function scan(str) {
    let regexp = new XRegExp(
      {
        InputElements: "<Whitespace>|<LineTerminator>|<Comments>|<Token>",
        Whitespace: / /,
        LineTerminator: /\n/,
        Comments: / |\n|\/\*(?:[^*]|\*[^\/])*\*\/|\/\/[^\n]*/,
        Token: "<Literal>|<Keywords>|<Identifer>|<Punctuator>",
        Literal: "<NumberLiteral>|<BooleanLiteral>|<StringLiteral>|<NullLiteral>",
        NumberLiteral: /(?:[1-9][0-9]*|0)(?:\.[0-9]*)?|\.[0-9]+/,
        BooleanLiteral: /true|false/,
        StringLiteral: /\"(?:[^"\n]|\\[\s\S])*\"|\'(?:[^'\n]|\\[\s\S])*\'/,
        NullLiteral: /null/,
        Identifer: /[a-zA-Z_$][a-zA-Z0-9_$]*/,
        Keywords: /if|else|for|function|let/,
        Punctuator:/\=\>|\(|\=|\<|\+\+|\=\=|\*|\.|\)|\[|\]|\;|\{|\}|\?|\:|\,|\+/
      },
      "g",
      "InputElements"
    );
    // console.log(new RegExp(reg, "g"));
    // let regexp = new RegExp(reg, "g");
    // let regexp = / |\n|\/\*([^*]|\*[^\/])*\*\/|\/\/[^\n]*|[1-9][0-9]*|0/g;
    while (regexp.lastIndex < str.length && regexp.lastIndex!==-1) {
      let r = regexp.exec(str);
      document.write(r[0])
      console.log(r[0]);
    }
  }
  scan(`
  for (let i = 0; i < 3; i++) {
      for (let j = 0; j < 3; j++) {
          let cell = document.createElement('div');
          cell.classList.add('cell');
          cell.innerHTML = pattern[i * 3 + j] === 2 ? "X" : pattern[i * 3 + j] === 1 ? "O" : "";
          cell.addEventListener('click', () => useMove(j, i));
          bord.appendChild(cell);
      }
      bord.appendChild(document.createElement('br'))
  }
  `);
</script>
</pre>
